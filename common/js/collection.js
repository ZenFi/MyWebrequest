// Generated by CoffeeScript 1.10.0

/**
 * all rules gather together to be a collection
 */
var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

(function(root, factory) {
  if (typeof define === 'function' && (define.amd || define.cmd)) {
    define(function() {
      return factory(root);
    });
  } else if (typeof exports === 'object') {
    module.exports = factory(root);
  } else {
    root.collection = factory(root);
  }
})(this, function(root) {
  var addRule, cats, collection, eachRule, getConfig, getLocal, getRules, getSwitch, hasCat, hasRule, initCollection, removeLocal, removeRule, saveRule, setConfig, setLocal, setSwitch;
  collection = {};
  cats = ['block', 'hsts', 'hotlink', 'log', 'custom', 'gsearch'];
  hasCat = function(cat) {
    return ~cats.indexOf(cat);
  };
  getRules = function(cat) {
    var rules;
    rules = collection[cat];
    if (cat === 'custom') {
      return Object.keys(rules);
    } else {
      return rules;
    }
  };
  initCollection = function() {
    var cat, i, len;
    for (i = 0, len = cats.length; i < len; i++) {
      cat = cats[i];
      if (cat === 'custom') {
        collection[cat] = JSON.parse(localStorage.getItem(cat) || '{}');
      } else {
        collection[cat] = JSON.parse(localStorage.getItem(cat) || '[]');
      }
    }
  };
  hasRule = function(cat, rule) {
    var rules;
    rules = collection[cat];
    if (!rules) {
      return false;
    }
    if (cat === 'custom') {
      return !!rules[rule];
    } else {
      return indexOf.call(rules, rule) >= 0;
    }
  };
  addRule = function(cat, rule) {
    if (!rule || hasRule(cat, rule)) {
      return false;
    }
    if (cat === 'custom') {
      rules[rule.url] = rule;
    } else {
      rules.push(rule);
    }
    saveRule(cat);
    return true;
  };
  removeRule = function(cat, rules) {
    var _rules;
    _rules = getRules(cat);
    if (rules === void 0 || (Array.isArray(rules) && _rules.length === rules.length)) {
      collection[cat] = null;
    } else {
      if (!Array.isArray(rules)) {
        rules = [rules];
      }
      rules.forEach(function(rule) {
        var index;
        if (cat === 'custom') {
          delete collection[cat][rule];
        } else {
          index = _rules.indexOf(rule);
          delete _rules[index];
        }
      });
    }
    saveRule(cat);
  };
  saveRule = function(cat) {
    var rules;
    rules = collection[cat];
    if (rules) {
      localStorage.removeItem(cat);
    } else {
      localStorage.setItem(cat, JSON.stringify(rules));
    }
    initCollection();
  };
  eachRule = function(cat, fn, context) {
    var rules;
    rules = collection[cat];
    if (!rules) {
      return;
    }
    rules.forEach(function(rule) {
      if (rule !== void 0) {
        fn.call(context, rule);
      }
    });
  };
  getSwitch = function(cat) {
    var onoff;
    onoff = JSON.parse(localStorage.getItem('onoff') || '{}');
    return !!onoff[cat];
  };
  setSwitch = function(cat, isOn) {
    var onoff;
    onoff = JSON.parse(localStorage.getItem('onoff') || '{}');
    onoff[cat] = !!isOn;
    localStorage.setItem('onoff', JSON.stringify(onoff));
  };
  getConfig = function(key) {
    var config;
    config = JSON.parse(localStorage.getItem('config') || '{}');
    return config[key];
  };
  setConfig = function(key, val) {
    var config;
    config = JSON.parse(localStorage.getItem('config') || '{}');
    config[key] = val;
    localStorage.setItem('config', JSON.stringify(config));
  };
  getLocal = function(key, expectFormat) {
    switch (expectFormat) {
      case 'object':
      case 'o':
        return JSON.parse(localStorage.getItem(key) || '{}');
      case 'array':
      case 'a':
        return JSON.parse(localStorage.getItem(key) || '[]');
      default:
        return localStorage.getItem(key);
    }
  };
  setLocal = function(key, val) {
    localStorage.setItem(key, JSON.stringify(val));
    initCollection();
  };
  removeLocal = function(key) {
    localStorage.removeItem(key);
    initCollection();
  };
  initCollection();
  return {
    _collection: collection,
    hasCat: hasCat,
    addRule: addRule,
    getRules: getRules,
    removeRule: removeRule,
    saveRule: saveRule,
    eachRule: eachRule,
    getLocal: getLocal,
    setLocal: setLocal,
    getSwitch: getSwitch,
    setSwitch: setSwitch,
    getConfig: getConfig,
    setConfig: setConfig
  };
});


//# sourceMappingURL=collection.js.map
